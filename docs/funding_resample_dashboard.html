<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <title>资金费率 Resample 看板</title>
    <style>
      :root {
        color-scheme: dark;
        font-family: "Segoe UI", "PingFang SC", "Helvetica Neue", sans-serif;
        --bg: #0d1117;
        --bg-soft: #161b22;
        --border: #30363d;
        --text: #e6edf3;
        --muted: #8b949e;
        --accent-green: #3fb950;
        --accent-red: #f85149;
        --accent-dark: #010409;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      header {
        padding: 16px 24px;
        border-bottom: 1px solid var(--border);
        background: var(--bg-soft);
        display: flex;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
      }
      header h1 {
        margin: 0;
        font-size: 20px;
      }
      .status {
        display: flex;
        gap: 12px;
        align-items: center;
        font-size: 14px;
        color: var(--muted);
      }
      .status span.indicator {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        display: inline-block;
        margin-right: 6px;
      }
      .indicator.ok {
        background: var(--accent-green);
      }
      .indicator.err {
        background: var(--accent-red);
      }
      .indicator.warn {
        background: #d29922;
      }
      .controls {
        margin-left: auto;
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .controls input {
        padding: 6px 10px;
        background: var(--bg);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 6px;
        min-width: 180px;
      }
      .controls button {
        padding: 6px 12px;
        border: 1px solid var(--border);
        border-radius: 6px;
        background: transparent;
        color: var(--text);
        cursor: pointer;
      }
      .controls button:hover {
        border-color: var(--text);
      }
      main {
        flex: 1;
        overflow: hidden;
        padding: 0 24px 24px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
      }
      thead {
        background: var(--bg-soft);
        position: sticky;
        top: 0;
        z-index: 1;
      }
      th,
      td {
        padding: 10px 12px;
        text-align: right;
        border-bottom: 1px solid var(--border);
        font-variant-numeric: tabular-nums;
      }
      th:first-child,
      td:first-child {
        text-align: left;
      }
      tr.triggered {
        border-left: 3px solid var(--accent-green);
      }
      tr.triggered.negative {
        border-left-color: var(--accent-red);
      }
      .metric {
        display: inline-flex;
        min-width: 96px;
        padding: 4px 8px;
        border-radius: 6px;
        justify-content: flex-end;
        color: var(--text);
        background: var(--bg-soft);
      }
      .metric.below {
        background: rgba(248, 81, 73, 0.2);
        color: var(--accent-red);
      }
      .metric.above {
        background: rgba(63, 185, 80, 0.2);
        color: var(--accent-green);
      }
      .metric.band {
        background: rgba(1, 4, 9, 0.72);
        color: #d0d7de;
      }
      .metric.na {
        color: var(--muted);
      }
      .age.stale {
        color: var(--accent-red);
      }
      .symbol {
        font-weight: 600;
        font-size: 14px;
      }
      .symbol small {
        display: block;
        color: var(--muted);
        font-weight: 400;
        font-size: 12px;
      }
      .empty {
        padding: 80px 0;
        text-align: center;
        color: var(--muted);
      }
      @media (max-width: 960px) {
        header {
          flex-direction: column;
          align-items: flex-start;
        }
        .controls {
          margin-left: 0;
        }
        th,
        td {
          padding: 8px 6px;
        }
        .metric {
          min-width: unset;
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>资金费率套利 Resample</h1>
      <div class="status">
        <span class="indicator warn" id="ws-indicator"></span>
        <span id="ws-status">等待连接…</span>
        <span id="last-update">最后刷新：-</span>
      </div>
      <div class="controls">
        <input id="filter-input" placeholder="按 Symbol 过滤 (模糊匹配)" />
        <button id="reload-btn" title="强制重连 WebSocket">重连</button>
        <button id="demo-btn" title="加载示例数据（离线调试）">示例数据</button>
      </div>
    </header>
    <main>
      <table>
        <thead>
          <tr>
            <th>Symbol</th>
            <th>BidAsk SR</th>
            <th>AskBid SR</th>
            <th>预测 Funding</th>
            <th>资金 MA</th>
            <th>即时 Funding</th>
            <th>借贷 8h</th>
            <th>更新时间</th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>
      <div class="empty" id="empty-hint">暂无数据</div>
    </main>
    <script>
      (function () {
        const WS_URL =
          window.FUNDING_RESAMPLE_WS_URL ||
          "ws://localhost:12000/ws?stream=fr_resample";
        const RECONNECT_MS = 5000;
        const STALE_MS = 10_000;

        const state = {
          ws: null,
          reconnectTimer: null,
          data: new Map(),
          lastServerTs: null,
        };

        const indicator = document.getElementById("ws-indicator");
        const statusEl = document.getElementById("ws-status");
        const lastUpdateEl = document.getElementById("last-update");
        const tbody = document.getElementById("table-body");
        const emptyHint = document.getElementById("empty-hint");
        const filterInput = document.getElementById("filter-input");
        const reloadBtn = document.getElementById("reload-btn");
        const demoBtn = document.getElementById("demo-btn");

        const numberFormat = new Intl.NumberFormat("en-US", {
          minimumFractionDigits: 6,
          maximumFractionDigits: 6,
        });

        function setStatus(colorClass, text) {
          indicator.className = `indicator ${colorClass}`;
          statusEl.textContent = text;
        }

        function formatValue(value) {
          if (value === null || value === undefined) return "--";
          if (!Number.isFinite(value)) return "--";
          return numberFormat.format(value);
        }

        function classifyBand(value, lower, upper) {
          if (value === null || value === undefined) {
            return { cls: "na", tooltip: "无数据", triggered: false };
          }
          const val = Number(value);
          if (!Number.isFinite(val)) {
            return { cls: "na", tooltip: "无数据", triggered: false };
          }
          const hasLower =
            lower !== null && lower !== undefined && Number.isFinite(lower);
          const hasUpper =
            upper !== null && upper !== undefined && Number.isFinite(upper);

          if (hasLower && val < lower) {
            return {
              cls: "below",
              tooltip: `值 ${val.toExponential(4)} < lower ${lower}`,
              triggered: true,
            };
          }
          if (hasUpper && val > upper) {
            return {
              cls: "above",
              tooltip: `值 ${val.toExponential(4)} > upper ${upper}`,
              triggered: true,
            };
          }
          if (hasLower && hasUpper) {
            return {
              cls: "band",
              tooltip: `lower ${lower} ≤ 值 ≤ upper ${upper}`,
              triggered: false,
            };
          }
          return {
            cls: "band",
            tooltip: "无阈值限制",
            triggered: false,
          };
        }

        function classifyAskBid(value, lower, upper) {
          if (value === null || value === undefined) {
            return { cls: "na", tooltip: "无数据", triggered: false };
          }
          const val = Number(value);
          if (!Number.isFinite(val)) {
            return { cls: "na", tooltip: "无数据", triggered: false };
          }
          const hasLower =
            lower !== null && lower !== undefined && Number.isFinite(lower);
          const hasUpper =
            upper !== null && upper !== undefined && Number.isFinite(upper);

          if (hasLower && val > lower) {
            return {
              cls: "above",
              tooltip: `值 ${val.toExponential(4)} > lower ${lower}（开仓阈）`,
              triggered: true,
            };
          }
          if (hasUpper && val < upper) {
            return {
              cls: "below",
              tooltip: `值 ${val.toExponential(4)} < upper ${upper}（平仓阈）`,
              triggered: true,
            };
          }
          if (hasLower || hasUpper) {
            return {
              cls: "band",
              tooltip: `阈值区间：>${lower ?? "-"} / <${upper ?? "-"}`,
              triggered: false,
            };
          }
          return {
            cls: "band",
            tooltip: "无阈值限制",
            triggered: false,
          };
        }

        function isTriggered(entry) {
          const checks = [
            classifyBand(entry.bidask_sr, entry.bidask_lower, entry.bidask_upper),
            classifyAskBid(
              entry.askbid_sr,
              entry.askbid_lower,
              entry.askbid_upper
            ),
            classifyBand(
              entry.predicted_rate,
              entry.predicted_rate_lower,
              entry.predicted_rate_upper
            ),
            classifyBand(
              entry.funding_rate_ma,
              entry.funding_rate_ma_lower,
              entry.funding_rate_ma_upper
            ),
          ];
          const anyAbove = checks.some((c) => c.triggered && c.cls === "above");
          const anyBelow = checks.some((c) => c.triggered && c.cls === "below");
          const triggered = checks.some((c) => c.triggered);
          return { triggered, anyBelow, anyAbove };
        }

        function render() {
          const filter = filterInput.value.trim().toUpperCase();
          const rows = Array.from(state.data.values());
          rows.sort((a, b) => {
            const ta = isTriggered(a).triggered ? 1 : 0;
            const tb = isTriggered(b).triggered ? 1 : 0;
            if (ta !== tb) return tb - ta;
            return (b.ts_ms ?? 0) - (a.ts_ms ?? 0);
          });

          tbody.innerHTML = "";
          let rendered = 0;
          const now = Date.now();

          for (const entry of rows) {
            if (filter && !entry.symbol.includes(filter)) continue;
            rendered += 1;

            const triggerInfo = isTriggered(entry);
            const tr = document.createElement("tr");
            if (triggerInfo.triggered) {
              tr.classList.add("triggered");
              if (triggerInfo.anyBelow && !triggerInfo.anyAbove) {
                tr.classList.add("negative");
              }
            }

            const ageMs = now - (entry.received_ms ?? now);
            const stale = ageMs > STALE_MS;
            const ageText =
              ageMs < 1000
                ? "刚刚"
                : ageMs < 60_000
                ? `${Math.floor(ageMs / 1000)} 秒前`
                : `${Math.floor(ageMs / 60000)} 分钟前`;

            const cells = [
              (() => {
                const td = document.createElement("td");
                td.innerHTML = `<div class="symbol">${entry.symbol}</div><small>${entry.funding_frequency || "-"} | ${new Date(entry.ts_ms || now).toLocaleTimeString()}</small>`;
                return td;
              })(),
              buildMetricCell(
                entry.bidask_sr,
                entry.bidask_lower,
                entry.bidask_upper,
                classifyBand
              ),
              buildMetricCell(
                entry.askbid_sr,
                entry.askbid_lower,
                entry.askbid_upper,
                classifyAskBid
              ),
              buildMetricCell(
                entry.predicted_rate,
                entry.predicted_rate_lower,
                entry.predicted_rate_upper,
                classifyBand
              ),
              buildMetricCell(
                entry.funding_rate_ma,
                entry.funding_rate_ma_lower,
                entry.funding_rate_ma_upper,
                classifyBand
              ),
              buildMetricCell(entry.funding_rate, null, null, classifyBand),
              buildMetricCell(entry.loan_rate_8h, null, null, classifyBand),
              (() => {
                const td = document.createElement("td");
                td.className = "age" + (stale ? " stale" : "");
                td.textContent = ageText;
                td.title = `采样时间: ${new Date(
                  entry.ts_ms || now
                ).toLocaleString()}`;
                return td;
              })(),
            ];

            for (const td of cells) {
              tr.appendChild(td);
            }
            tbody.appendChild(tr);
          }

          emptyHint.style.display = rendered === 0 ? "block" : "none";
        }

        function buildMetricCell(value, lower, upper, classifier) {
          const td = document.createElement("td");
          const { cls, tooltip } = classifier(value, lower, upper);
          const span = document.createElement("span");
          span.className = `metric ${cls}`;
          span.textContent = formatValue(value);
          span.title =
            tooltip ||
            `lower=${lower ?? "-"} / upper=${upper ?? "-"}`;
          td.appendChild(span);
          return td;
        }

        function handleEntry(entry, ts_ms) {
          const enriched = {
            ...entry,
            received_ms: Date.now(),
            server_ts_ms: ts_ms ?? null,
          };
          state.data.set(entry.symbol, enriched);
          state.lastServerTs = ts_ms ?? entry.ts_ms ?? Date.now();
          lastUpdateEl.textContent = `最后刷新：${new Date(
            state.lastServerTs
          ).toLocaleTimeString()}`;
          render();
        }

        function handleMessage(ev) {
          let payload;
          try {
            payload = JSON.parse(ev.data);
          } catch (err) {
            console.warn("无法解析消息", err);
            return;
          }

          if (payload.type === "fr_resample_entry" && payload.entry) {
            handleEntry(payload.entry, payload.ts_ms);
          } else if (
            payload.type === "fr_resample_snapshot" &&
            Array.isArray(payload.entries)
          ) {
            state.data.clear();
            for (const entry of payload.entries) {
              handleEntry(entry, payload.ts_ms);
            }
          } else if (payload.type === "ping") {
            // 可按需回 pong
          } else if (payload.type === "error") {
            setStatus("err", `错误：${payload.message || "unknown"}`);
          }
        }

        function connect() {
          if (state.ws) {
            state.ws.close();
            state.ws = null;
          }
          setStatus("warn", "连接中…");
          try {
            const ws = new WebSocket(WS_URL);
            state.ws = ws;
            ws.addEventListener("open", () => {
              setStatus("ok", "已连接");
              if (state.reconnectTimer) {
                clearTimeout(state.reconnectTimer);
                state.reconnectTimer = null;
              }
            });
            ws.addEventListener("message", handleMessage);
            ws.addEventListener("close", () => {
              setStatus("warn", "连接断开，准备重试…");
              scheduleReconnect();
            });
            ws.addEventListener("error", (err) => {
              console.error("WS 错误", err);
              setStatus("err", "连接异常");
              ws.close();
            });
          } catch (err) {
            console.error("创建 WS 失败", err);
            setStatus("err", "创建连接失败");
            scheduleReconnect();
          }
        }

        function scheduleReconnect() {
          if (state.reconnectTimer) return;
          state.reconnectTimer = setTimeout(() => {
            state.reconnectTimer = null;
            connect();
          }, RECONNECT_MS);
        }

        filterInput.addEventListener("input", render);
        reloadBtn.addEventListener("click", () => {
          connect();
        });
        demoBtn.addEventListener("click", () => {
          const now = Date.now();
          const demoEntries = [
            {
              symbol: "BTCUSDT",
              ts_ms: now,
              funding_frequency: "8h",
              spot_bid: 70500.3,
              spot_ask: 70500.5,
              fut_bid: 70488.2,
              fut_ask: 70488.6,
              bidask_sr: 0.00017,
              askbid_sr: 0.00032,
              funding_rate: 0.000092,
              funding_rate_ma: 0.000084,
              funding_rate_ma_lower: -0.0008,
              funding_rate_ma_upper: 0.0008,
              predicted_rate: 0.00011,
              predicted_rate_lower: -0.00008,
              predicted_rate_upper: 0.00008,
              loan_rate_8h: 0.00014,
              bidask_lower: -0.0002,
              bidask_upper: 0.0005,
              askbid_lower: 0.0012,
              askbid_upper: 0.0002,
            },
            {
              symbol: "ETHUSDT",
              ts_ms: now,
              funding_frequency: "8h",
              spot_bid: 3600.1,
              spot_ask: 3600.2,
              fut_bid: 3598.3,
              fut_ask: 3598.6,
              bidask_sr: 0.00052,
              askbid_sr: 0.00092,
              funding_rate: 0.000045,
              funding_rate_ma: 0.000032,
              funding_rate_ma_lower: -0.0008,
              funding_rate_ma_upper: 0.0008,
              predicted_rate: 0.00003,
              predicted_rate_lower: -0.00008,
              predicted_rate_upper: 0.00008,
              loan_rate_8h: 0.00005,
              bidask_lower: -0.0002,
              bidask_upper: 0.0005,
              askbid_lower: 0.0012,
              askbid_upper: 0.0002,
            },
            {
              symbol: "SOLUSDT",
              ts_ms: now,
              funding_frequency: "4h",
              spot_bid: 210.23,
              spot_ask: 210.28,
              fut_bid: 210.01,
              fut_ask: 210.05,
              bidask_sr: -0.00085,
              askbid_sr: 0.00152,
              funding_rate: -0.00024,
              funding_rate_ma: -0.00018,
              funding_rate_ma_lower: -0.0004,
              funding_rate_ma_upper: 0.0004,
              predicted_rate: -0.00046,
              predicted_rate_lower: -0.0004,
              predicted_rate_upper: 0.0004,
              loan_rate_8h: 0.00012,
              bidask_lower: -0.0006,
              bidask_upper: 0.0004,
              askbid_lower: 0.001,
              askbid_upper: 0.00015,
            },
          ];
          for (const entry of demoEntries) {
            handleEntry(entry, now);
          }
          setStatus("warn", "示例数据（离线）");
        });

        // 离线环境下可不自动连
        if (!window.DISABLE_AUTO_CONNECT) {
          connect();
        } else {
          setStatus("warn", "自动连接已禁用");
        }

        setInterval(render, 1000);
      })();
    </script>
  </body>
</html>
