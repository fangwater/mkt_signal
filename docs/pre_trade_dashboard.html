<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <title>预交易敞口/持仓/风控看板</title>
    <style>
      :root {
        color-scheme: dark;
        font-family: "Segoe UI", "PingFang SC", "Helvetica Neue", sans-serif;
        --bg: #0d1117;
        --bg-soft: #161b22;
        --border: #30363d;
        --text: #e6edf3;
        --muted: #8b949e;
        --accent-green: #3fb950;
        --accent-red: #f85149;
        --accent-warn: #d29922;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      header {
        padding: 16px 24px;
        border-bottom: 1px solid var(--border);
        background: var(--bg-soft);
        display: flex;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
      }
      header h1 {
        margin: 0;
        font-size: 20px;
      }
      .status {
        display: flex;
        gap: 12px;
        align-items: center;
        font-size: 14px;
        color: var(--muted);
      }
      .status span.indicator {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        display: inline-block;
        margin-right: 6px;
      }
      .indicator.ok {
        background: var(--accent-green);
      }
      .indicator.err {
        background: var(--accent-red);
      }
      .indicator.warn {
        background: var(--accent-warn);
      }
      .controls {
        margin-left: auto;
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .controls input {
        padding: 6px 10px;
        background: var(--bg);
        color: var(--text);
        border: 1px solid var(--border);
        border-radius: 6px;
        min-width: 220px;
      }
      .controls button {
        padding: 6px 12px;
        border: 1px solid var(--border);
        border-radius: 6px;
        background: transparent;
        color: var(--text);
        cursor: pointer;
      }
      .controls button:hover {
        border-color: var(--text);
      }
      main {
        flex: 1;
        overflow: auto;
        padding: 0 24px 32px;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }
      section.section {
        background: var(--bg-soft);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .section-header {
        display: flex;
        align-items: baseline;
        gap: 16px;
        flex-wrap: wrap;
      }
      .section-header h2 {
        margin: 0;
        font-size: 18px;
      }
      .section-meta {
        font-size: 13px;
        color: var(--muted);
      }
      .section-meta.stale {
        color: var(--accent-red);
      }
      .card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 16px;
      }
      .metric-card {
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 16px;
        background: var(--bg);
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .metric-card h3 {
        margin: 0;
        font-size: 14px;
        color: var(--muted);
        font-weight: 500;
      }
      .metric-card .value {
        font-size: 22px;
        font-weight: 600;
        line-height: 1.2;
      }
      .metric-card .hint {
        font-size: 12px;
        color: var(--muted);
      }
      .metric-card.warn .value {
        color: var(--accent-red);
      }
      .table-wrapper {
        overflow: auto;
      .table-wrapper.compact {
        max-width: 600px;
      }
      .metrics-table {
        width: 100%;
        border-collapse: collapse;
      }
      .metrics-table th,
      .metrics-table td {
        padding: 8px 12px;
        border-bottom: 1px solid var(--border);
        text-align: left;
      }
      .metrics-table td.value {
        text-align: right;
        font-variant-numeric: tabular-nums;
      }
      .metrics-table tr:last-child td {
        border-bottom: none;
      }
        border: 1px solid var(--border);
        border-radius: 10px;
        background: var(--bg);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 720px;
      }
      thead {
        background: var(--bg-soft);
        position: sticky;
        top: 0;
        z-index: 1;
      }
      th,
      td {
        padding: 10px 12px;
        text-align: right;
        border-bottom: 1px solid var(--border);
        font-variant-numeric: tabular-nums;
      }
      th:first-child,
      td:first-child {
        text-align: left;
      }
      tbody tr:last-child td {
        border-bottom: none;
      }
      tr.total-row {
        background: rgba(63, 185, 80, 0.08);
      }
      tr.stale {
        opacity: 0.7;
      }
      td.negative {
        color: var(--accent-red);
      }
      td.positive {
        color: var(--accent-green);
      }
      td.muted {
        color: var(--muted);
      }
      .empty {
        text-align: center;
        padding: 48px 0;
        color: var(--muted);
      }
      .grid-two {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 16px;
      }
      .sub-section-title {
        margin: 0 0 8px 0;
        font-size: 16px;
      }
      .sub-meta {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 8px;
      }
      @media (max-width: 960px) {
        header {
          flex-direction: column;
          align-items: flex-start;
        }
        .controls {
          margin-left: 0;
          width: 100%;
        }
        .controls input {
          flex: 1;
        }
        table {
          min-width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>预交易风控看板</h1>
      <div class="status">
        <span class="indicator warn" id="ws-indicator"></span>
        <span id="ws-status">等待连接…</span>
        <span id="last-update">最后刷新：-</span>
      </div>
      <div class="controls">
        <input
          id="filter-input"
          placeholder="按资产 / Symbol 过滤（模糊匹配）"
        />
        <button id="reload-btn" title="强制重连 WebSocket">重连</button>
        <button id="demo-btn" title="加载示例数据（离线调试）">示例数据</button>
      </div>
    </header>
    <main>
      <section class="section" id="risk-section">
        <div class="section-header">
          <h2>风控指标</h2>
          <span class="section-meta" id="risk-update">更新时间：-</span>
        </div>
        <div class="card-grid">
          <div class="metric-card" id="metric-equity">
            <h3>总权益</h3>
            <div class="value" id="risk-equity">--</div>
            <div class="hint">基于最新账户快照估算</div>
          </div>
          <div class="metric-card" id="metric-exposure">
            <h3>总敞口</h3>
            <div class="value" id="risk-exposure">--</div>
            <div class="hint">现货 + 合约折算 USDT</div>
          </div>
          <div class="metric-card" id="metric-position">
            <h3>总仓位</h3>
            <div class="value" id="risk-position">--</div>
            <div class="hint">含所有合约名义价值</div>
          </div>
          <div class="metric-card" id="metric-leverage">
            <h3>杠杆倍数</h3>
            <div class="value" id="risk-leverage">--</div>
            <div class="hint">= 总仓位 / 总权益</div>
          </div>
          <div class="metric-card" id="metric-max-leverage">
            <h3>最大杠杆</h3>
            <div class="value" id="risk-max-leverage">--</div>
            <div class="hint">策略配置的风控阈值</div>
          </div>
        </div>

        <div class="table-wrapper compact" id="equity-table-wrapper">
          <table class="metrics-table">
            <thead>
              <tr>
                <th>项目</th>
                <th>数值 (USDT)</th>
                <th>说明</th>
              </tr>
            </thead>
            <tbody id="equity-breakdown-body">
              <tr><td>现货估值</td><td class="value">--</td><td>Σ 现货数量 × 标记价</td></tr>
              <tr><td>借币折算</td><td class="value">--</td><td>以标记价折算的交叉借币</td></tr>
              <tr><td>利息折算</td><td class="value">--</td><td>以标记价折算的交叉利息</td></tr>
              <tr><td>UM 未实现PnL</td><td class="value">--</td><td>Σ 合约未实现盈亏</td></tr>
              <tr><td>总权益</td><td class="value">--</td><td>现货估值 − 借币 − 利息 + UM 未实现PnL</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="section" id="exposure-section">
        <div class="section-header">
          <h2>资产敞口</h2>
          <span class="section-meta" id="exposure-update">更新时间：-</span>
        </div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>资产</th>
                <th>现货数量</th>
                <th>现货估值 (USDT)</th>
                <th>UM 净数量</th>
                <th>UM 估值 (USDT)</th>
                <th>总敞口数量</th>
                <th>总敞口 (USDT)</th>
              </tr>
            </thead>
            <tbody id="exposure-body"></tbody>
          </table>
        </div>
        <div class="empty" id="exposure-empty">暂无敞口数据</div>
      </section>

      <section class="section" id="positions-section">
        <div class="section-header">
          <h2>账户持仓</h2>
          <span class="section-meta" id="positions-update">更新时间：-</span>
        </div>
        <div class="grid-two">
          <div>
            <h3 class="sub-section-title">UM 合约持仓</h3>
            <div class="sub-meta" id="um-sub-meta">已接收 0 条记录</div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Symbol</th>
                    <th>方向</th>
                    <th>仓位数量</th>
                    <th>开仓均价</th>
                    <th>杠杆</th>
                    <th>仓位保证金</th>
                    <th>挂单保证金</th>
                    <th>未实现盈亏</th>
                  </tr>
                </thead>
                <tbody id="um-body"></tbody>
              </table>
            </div>
            <div class="empty" id="um-empty">暂无合约持仓</div>
          </div>
          <div>
            <h3 class="sub-section-title">现货余额</h3>
            <div class="sub-meta" id="spot-sub-meta">已接收 0 条记录</div>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>资产</th>
                    <th>总余额</th>
                    <th>可用</th>
                    <th>锁定</th>
                    <th>借入</th>
                    <th>利息</th>
                  </tr>
                </thead>
                <tbody id="spot-body"></tbody>
              </table>
            </div>
            <div class="empty" id="spot-empty">暂无现货余额</div>
          </div>
        </div>
      </section>
    </main>

    <script>
      (function () {
        const WS_URL =
          window.PRE_TRADE_WS_URL ||
          "ws://54.64.147.69:4190/ws?stream=pre_trade";
        const RECONNECT_MS = 5000;
        const STALE_MS = 15_000;

        const state = {
          ws: null,
          reconnectTimer: null,
          lastServerTs: null,
          lastMessageAt: null,
          risk: null,
          exposure: null,
          positions: null,
        };

        const dirty = {
          risk: true,
          exposure: true,
          positions: true,
        };

        const indicator = document.getElementById("ws-indicator");
        const statusEl = document.getElementById("ws-status");
        const lastUpdateEl = document.getElementById("last-update");
        const filterInput = document.getElementById("filter-input");
        const reloadBtn = document.getElementById("reload-btn");
        const demoBtn = document.getElementById("demo-btn");

        const riskUpdateEl = document.getElementById("risk-update");
        const exposureUpdateEl = document.getElementById("exposure-update");
        const positionsUpdateEl = document.getElementById("positions-update");

        const riskEquityEl = document.getElementById("risk-equity");
        const riskExposureEl = document.getElementById("risk-exposure");
        const riskPositionEl = document.getElementById("risk-position");
        const riskLeverageEl = document.getElementById("risk-leverage");
        const riskMaxLeverageEl =
          document.getElementById("risk-max-leverage");

        const riskSection = document.getElementById("risk-section");
        const exposureSection = document.getElementById("exposure-section");
        const positionsSection = document.getElementById("positions-section");

        const exposureBody = document.getElementById("exposure-body");
        const exposureEmpty = document.getElementById("exposure-empty");

        const umBody = document.getElementById("um-body");
        const umEmpty = document.getElementById("um-empty");
        const umSubMeta = document.getElementById("um-sub-meta");

        const spotBody = document.getElementById("spot-body");
        const spotEmpty = document.getElementById("spot-empty");
        const spotSubMeta = document.getElementById("spot-sub-meta");
        const equityBreakdownBody = document.getElementById("equity-breakdown-body");

        const formatQty = new Intl.NumberFormat("en-US", {
          minimumFractionDigits: 4,
          maximumFractionDigits: 4,
        });
        const formatUsd = new Intl.NumberFormat("en-US", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });
        const formatLev = new Intl.NumberFormat("en-US", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });

        function setStatus(colorClass, text) {
          indicator.className = `indicator ${colorClass}`;
          statusEl.textContent = text;
        }

        function relativeText(ms) {
          if (ms < 0) ms = 0;
          if (ms < 1000) return "刚刚";
          if (ms < 60_000) return `${Math.floor(ms / 1000)} 秒前`;
          if (ms < 3_600_000)
            return `${Math.floor(ms / 60_000)} 分钟前`;
          return `${Math.floor(ms / 3_600_000)} 小时前`;
        }

        function formatNumber(value, formatter) {
          if (value === null || value === undefined) return "--";
          if (!Number.isFinite(value)) return "--";
          return formatter.format(value);
        }

        function classifySign(value) {
          if (value === null || value === undefined) return "muted";
          if (!Number.isFinite(value)) return "muted";
          if (value > 0) return "positive";
          if (value < 0) return "negative";
          return "";
        }

        function renderEquityBreakdown(entry) {
          if (!equityBreakdownBody) return;
          const rows = entry
            ? [
                {
                  label: "现货估值",
                  value: Number.isFinite(entry.spot_equity_usd) ? entry.spot_equity_usd : null,
                  hint: "Σ 现货数量 × 标记价",
                },
                {
                  label: "借币折算",
                  value: Number.isFinite(entry.borrowed_usd) ? -entry.borrowed_usd : null,
                  hint: "以标记价折算的交叉借币",
                },
                {
                  label: "利息折算",
                  value: Number.isFinite(entry.interest_usd) ? -entry.interest_usd : null,
                  hint: "以标记价折算的交叉利息",
                },
                {
                  label: "UM 未实现PnL",
                  value: Number.isFinite(entry.um_unrealized_usd) ? entry.um_unrealized_usd : null,
                  hint: "Σ 合约未实现盈亏",
                },
                {
                  label: "总权益",
                  value: Number.isFinite(entry.total_equity) ? entry.total_equity : null,
                  hint: "现货估值 − 借币 − 利息 + UM 未实现PnL",
                  isTotal: true,
                },
              ]
            : [
                { label: "现货估值", value: null, hint: "Σ 现货数量 × 标记价" },
                { label: "借币折算", value: null, hint: "以标记价折算的交叉借币" },
                { label: "利息折算", value: null, hint: "以标记价折算的交叉利息" },
                { label: "UM 未实现PnL", value: null, hint: "Σ 合约未实现盈亏" },
                { label: "总权益", value: null, hint: "现货估值 − 借币 − 利息 + UM 未实现PnL", isTotal: true },
              ];

          equityBreakdownBody.innerHTML = "";
          for (const row of rows) {
            const tr = document.createElement("tr");
            if (row.isTotal) {
              tr.classList.add("total-row");
            }
            const nameTd = document.createElement("td");
            nameTd.textContent = row.label;
            const valueTd = document.createElement("td");
            valueTd.className = "value";
            valueTd.classList.add(classifySign(row.value));
            valueTd.textContent = formatNumber(row.value, formatUsd);
            const hintTd = document.createElement("td");
            hintTd.textContent = row.hint;
            tr.appendChild(nameTd);
            tr.appendChild(valueTd);
            tr.appendChild(hintTd);
            equityBreakdownBody.appendChild(tr);
          }
        }

        function matchesFilter(text, filter) {
          if (!filter) return true;
          if (!text) return false;
          return text.toUpperCase().includes(filter);
        }

        function setSectionMeta(el, section, entry) {
          const now = Date.now();
          if (!entry) {
            el.textContent = "更新时间：-";
            el.classList.remove("stale");
            section.classList.remove("stale");
            return;
          }
          const received = entry.received_ms ?? now;
          const age = now - received;
          const ts = entry.server_ts_ms ?? entry.ts_ms ?? null;
          const tsText = ts
            ? new Date(ts).toLocaleTimeString()
            : "--";
          el.textContent = `更新时间：${tsText}（${relativeText(age)}）`;
          if (age > STALE_MS) {
            el.classList.add("stale");
            section.classList.add("stale");
          } else {
            el.classList.remove("stale");
            section.classList.remove("stale");
          }
        }

        function updateRiskSection() {
          if (!dirty.risk) return;
          dirty.risk = false;
          const entry = state.risk;
          if (!entry) {
            riskEquityEl.textContent = "--";
            riskExposureEl.textContent = "--";
            riskPositionEl.textContent = "--";
            riskLeverageEl.textContent = "--";
            riskMaxLeverageEl.textContent = "--";
            renderEquityBreakdown(null);
            return;
          }
          riskEquityEl.textContent = formatNumber(
            entry.total_equity,
            formatUsd
          );
          riskExposureEl.textContent = formatNumber(
            entry.total_exposure,
            formatUsd
          );
          riskPositionEl.textContent = formatNumber(
            entry.total_position,
            formatUsd
          );
          riskLeverageEl.textContent = formatNumber(
            entry.leverage,
            formatLev
          );
          riskMaxLeverageEl.textContent = formatNumber(
            entry.max_leverage,
            formatLev
          );

          const leverageCard = document.getElementById("metric-leverage");
          if (
            Number.isFinite(entry.leverage) &&
            Number.isFinite(entry.max_leverage) &&
            entry.max_leverage > 0 &&
            entry.leverage > entry.max_leverage
          ) {
            leverageCard.classList.add("warn");
          } else {
            leverageCard.classList.remove("warn");
          }
          renderEquityBreakdown(entry);
        }

        function renderExposureRows() {
          if (!dirty.exposure) return;
          dirty.exposure = false;
          const entry = state.exposure;
          exposureBody.innerHTML = "";
          const filter = filterInput.value.trim().toUpperCase();
          if (!entry || !Array.isArray(entry.rows) || entry.rows.length === 0) {
            exposureEmpty.style.display = "block";
            return;
          }

          let rendered = 0;
          for (const row of entry.rows) {
            const asset = row.asset || "";
            if (row.is_total && rendered === 0 && filter && !matchesFilter("TOTAL", filter)) {
              // 若仅有总计且过滤不匹配，则跳过
              continue;
            }
            if (!row.is_total && filter && !matchesFilter(asset, filter)) {
              continue;
            }

            rendered += 1;
            const tr = document.createElement("tr");
            if (row.is_total) {
              tr.classList.add("total-row");
            }

            const cells = [
              (() => {
                const td = document.createElement("td");
                td.textContent = asset || (row.is_total ? "TOTAL" : "--");
                return td;
              })(),
              (() => {
                const td = document.createElement("td");
                td.textContent = formatNumber(row.spot_qty, formatQty);
                td.className = classifySign(row.spot_qty);
                return td;
              })(),
              (() => {
                const td = document.createElement("td");
                td.textContent = formatNumber(row.spot_usdt, formatUsd);
                td.className = classifySign(row.spot_usdt);
                return td;
              })(),
              (() => {
                const td = document.createElement("td");
                td.textContent = formatNumber(row.um_net_qty, formatQty);
                td.className = classifySign(row.um_net_qty);
                return td;
              })(),
              (() => {
                const td = document.createElement("td");
                td.textContent = formatNumber(row.um_net_usdt, formatUsd);
                td.className = classifySign(row.um_net_usdt);
                return td;
              })(),
              (() => {
                const td = document.createElement("td");
                td.textContent = formatNumber(row.exposure_qty, formatQty);
                td.className = classifySign(row.exposure_qty);
                return td;
              })(),
              (() => {
                const td = document.createElement("td");
                td.textContent = formatNumber(row.exposure_usdt, formatUsd);
                td.className = classifySign(row.exposure_usdt);
                return td;
              })(),
            ];
            for (const td of cells) {
              tr.appendChild(td);
            }
            exposureBody.appendChild(tr);
          }
          exposureEmpty.style.display = rendered === 0 ? "block" : "none";
        }

        function renderPositionsTables() {
          if (!dirty.positions) return;
          dirty.positions = false;
          const entry = state.positions;
          umBody.innerHTML = "";
          spotBody.innerHTML = "";
          const filter = filterInput.value.trim().toUpperCase();

          let umCount = 0;
          let spotCount = 0;

          if (entry && Array.isArray(entry.um_positions)) {
            const sorted = [...entry.um_positions].sort((a, b) => {
              if (a.symbol === b.symbol) {
                return (b.position_amount ?? 0) - (a.position_amount ?? 0);
              }
              return (a.symbol || "").localeCompare(b.symbol || "");
            });

            for (const row of sorted) {
              const symbol = row.symbol || "";
              const side = row.side || "";
              if (
                filter &&
                !matchesFilter(symbol, filter) &&
                !matchesFilter(side, filter)
              ) {
                continue;
              }
              const tr = document.createElement("tr");
              const cells = [
                (() => {
                  const td = document.createElement("td");
                  td.textContent = symbol || "--";
                  return td;
                })(),
                (() => {
                  const td = document.createElement("td");
                  td.textContent = side || "--";
                  return td;
                })(),
                (() => {
                  const td = document.createElement("td");
                  td.textContent = formatNumber(
                    row.position_amount,
                    formatQty
                  );
                  td.className = classifySign(row.position_amount);
                  return td;
                })(),
                (() => {
                  const td = document.createElement("td");
                  td.textContent = formatNumber(
                    row.entry_price,
                    formatUsd
                  );
                  return td;
                })(),
                (() => {
                  const td = document.createElement("td");
                  td.textContent = formatNumber(row.leverage, formatLev);
                  return td;
                })(),
                (() => {
                  const td = document.createElement("td");
                  td.textContent = formatNumber(
                    row.position_initial_margin,
                    formatUsd
                  );
                  return td;
                })(),
                (() => {
                  const td = document.createElement("td");
                  td.textContent = formatNumber(
                    row.open_order_initial_margin,
                    formatUsd
                  );
                  return td;
                })(),
                (() => {
                  const td = document.createElement("td");
                  td.textContent = formatNumber(
                    row.unrealized_profit,
                    formatUsd
                  );
                  td.className = classifySign(row.unrealized_profit);
                  return td;
                })(),
              ];
              for (const td of cells) {
                tr.appendChild(td);
              }
              umBody.appendChild(tr);
              umCount += 1;
            }
          }

          let spotUmWallet = 0;
          let spotUmPnl = 0;
          let hasUmMetrics = false;

          if (entry && Array.isArray(entry.spot_balances)) {
            const sorted = [...entry.spot_balances].sort((a, b) =>
              (a.asset || "").localeCompare(b.asset || "")
            );

            for (const row of sorted) {
              const asset = row.asset || "";
              if (filter && !matchesFilter(asset, filter)) {
                continue;
              }
              const tr = document.createElement("tr");
              const cells = [
                (() => {
                  const td = document.createElement("td");
                  td.textContent = asset || "--";
                  return td;
                })(),
                (() => {
                  const td = document.createElement("td");
                  td.textContent = formatNumber(
                    row.total_wallet,
                    formatUsd
                  );
                  td.className = classifySign(row.total_wallet);
                  return td;
                })(),
                (() => {
                  const td = document.createElement("td");
                  td.textContent = formatNumber(row.cross_free, formatUsd);
                  return td;
                })(),
                (() => {
                  const td = document.createElement("td");
                  td.textContent = formatNumber(
                    row.cross_locked,
                    formatUsd
                  );
                  return td;
                })(),
                (() => {
                  const td = document.createElement("td");
                  td.textContent = formatNumber(
                    row.cross_borrowed,
                    formatUsd
                  );
                  td.className = classifySign(row.cross_borrowed);
                  return td;
                })(),
                (() => {
                  const td = document.createElement("td");
                  td.textContent = formatNumber(
                    row.cross_interest,
                    formatUsd
                  );
                  td.className = classifySign(row.cross_interest);
                  return td;
                })(),
              ];
              for (const td of cells) {
                tr.appendChild(td);
              }
              spotBody.appendChild(tr);
              spotCount += 1;

              if (Number.isFinite(row.um_wallet)) {
                spotUmWallet += row.um_wallet;
                hasUmMetrics = true;
              }
              if (Number.isFinite(row.um_unrealized_pnl)) {
                spotUmPnl += row.um_unrealized_pnl;
                hasUmMetrics = true;
              }
            }
          }

          umEmpty.style.display = umCount === 0 ? "block" : "none";
          spotEmpty.style.display = spotCount === 0 ? "block" : "none";
          umSubMeta.textContent = `已接收 ${umCount} 条记录`;
          if (hasUmMetrics) {
            const parts = [
              `已接收 ${spotCount} 条记录`,
              `UM 余额合计 ${formatUsd.format(spotUmWallet)}`,
              `UM 未实现PnL 合计 ${formatUsd.format(spotUmPnl)}`,
            ];
            spotSubMeta.textContent = parts.join(" ｜ ");
          } else {
            spotSubMeta.textContent = `已接收 ${spotCount} 条记录`;
          }
        }

        function updateMeta() {
          updateRiskSection();
          renderExposureRows();
          renderPositionsTables();

          setSectionMeta(riskUpdateEl, riskSection, state.risk);
          setSectionMeta(
            exposureUpdateEl,
            exposureSection,
            state.exposure
          );
          setSectionMeta(
            positionsUpdateEl,
            positionsSection,
            state.positions
          );

          if (state.lastServerTs) {
            const now = Date.now();
            const age =
              state.lastMessageAt !== null
                ? now - state.lastMessageAt
                : now - state.lastServerTs;
            lastUpdateEl.textContent = `最后刷新：${new Date(
              state.lastServerTs
            ).toLocaleTimeString()}（${relativeText(age)}）`;
          } else {
            lastUpdateEl.textContent = "最后刷新：-";
          }
        }

        function updateRisk(entry, serverTs) {
          state.risk = {
            ...entry,
            ts_ms: entry.ts_ms ?? serverTs ?? null,
            server_ts_ms: serverTs ?? entry.ts_ms ?? null,
            received_ms: Date.now(),
          };
          dirty.risk = true;
          state.lastServerTs =
            Math.max(
              state.lastServerTs || 0,
              state.risk.server_ts_ms || 0
            ) || state.risk.server_ts_ms;
          state.lastMessageAt = Date.now();
          updateMeta();
        }

        function updateExposure(entry, serverTs) {
          state.exposure = {
            ...entry,
            ts_ms: entry.ts_ms ?? serverTs ?? null,
            server_ts_ms: serverTs ?? entry.ts_ms ?? null,
            received_ms: Date.now(),
            rows: Array.isArray(entry.rows) ? entry.rows : [],
          };
          dirty.exposure = true;
          state.lastServerTs =
            Math.max(
              state.lastServerTs || 0,
              state.exposure.server_ts_ms || 0
            ) || state.exposure.server_ts_ms;
          state.lastMessageAt = Date.now();
          updateMeta();
        }

        function updatePositions(entry, serverTs) {
          state.positions = {
            ...entry,
            ts_ms: entry.ts_ms ?? serverTs ?? null,
            server_ts_ms: serverTs ?? entry.ts_ms ?? null,
            received_ms: Date.now(),
            um_positions: Array.isArray(entry.um_positions)
              ? entry.um_positions
              : [],
            spot_balances: Array.isArray(entry.spot_balances)
              ? entry.spot_balances
              : [],
          };
          dirty.positions = true;
          state.lastServerTs =
            Math.max(
              state.lastServerTs || 0,
              state.positions.server_ts_ms || 0
            ) || state.positions.server_ts_ms;
          state.lastMessageAt = Date.now();
          updateMeta();
        }

        function handleMessage(ev) {
          let payload;
          try {
            payload = JSON.parse(ev.data);
          } catch (err) {
            console.warn("解析 WS 消息失败", err);
            return;
          }

          if (payload.type === "pre_trade_risk" && payload.entry) {
            updateRisk(payload.entry, payload.ts_ms);
          } else if (
            payload.type === "pre_trade_exposure" &&
            payload.entry
          ) {
            updateExposure(payload.entry, payload.ts_ms);
          } else if (
            payload.type === "pre_trade_positions" &&
            payload.entry
          ) {
            updatePositions(payload.entry, payload.ts_ms);
          } else if (payload.type === "error") {
            setStatus("err", `错误：${payload.message || "unknown"}`);
          }
        }

        function connect() {
          if (state.ws) {
            state.ws.close();
            state.ws = null;
          }
          setStatus("warn", "连接中…");
          try {
            const ws = new WebSocket(WS_URL);
            state.ws = ws;
            ws.addEventListener("open", () => {
              setStatus("ok", "已连接");
              if (state.reconnectTimer) {
                clearTimeout(state.reconnectTimer);
                state.reconnectTimer = null;
              }
            });
            ws.addEventListener("message", handleMessage);
            ws.addEventListener("close", () => {
              setStatus("warn", "连接断开，准备重试…");
              scheduleReconnect();
            });
            ws.addEventListener("error", (err) => {
              console.error("WS 错误", err);
              setStatus("err", "连接异常");
              ws.close();
            });
          } catch (err) {
            console.error("创建 WS 失败", err);
            setStatus("err", "创建连接失败");
            scheduleReconnect();
          }
        }

        function scheduleReconnect() {
          if (state.reconnectTimer) return;
          state.reconnectTimer = setTimeout(() => {
            state.reconnectTimer = null;
            connect();
          }, RECONNECT_MS);
        }

        function loadDemoData() {
          const now = Date.now();
          const serverTs = now;
          updateRisk(
            {
              ts_ms: serverTs,
              total_equity: 120_000,
              total_exposure: 48_000,
              total_position: 72_000,
              spot_equity_usd: 150_000,
              borrowed_usd: 20_000,
              interest_usd: 1_000,
              um_unrealized_usd: -9_000,
              leverage: 0.6,
              max_leverage: 2.5,
            },
            serverTs
          );
          updateExposure(
            {
              ts_ms: serverTs,
              rows: [
                {
                  asset: "BTC",
                  spot_qty: 1.25,
                  spot_usdt: 87_500,
                  um_net_qty: -0.8,
                  um_net_usdt: -56_000,
                  exposure_qty: 0.45,
                  exposure_usdt: 31_500,
                  is_total: false,
                },
                {
                  asset: "ETH",
                  spot_qty: 50,
                  spot_usdt: 180_000,
                  um_net_qty: -30,
                  um_net_usdt: -108_000,
                  exposure_qty: 20,
                  exposure_usdt: 72_000,
                  is_total: false,
                },
                {
                  asset: "TOTAL",
                  spot_qty: null,
                  spot_usdt: null,
                  um_net_qty: null,
                  um_net_usdt: null,
                  exposure_qty: null,
                  exposure_usdt: 103_500,
                  is_total: true,
                },
              ],
            },
            serverTs
          );
          updatePositions(
            {
              ts_ms: serverTs,
              um_positions: [
                {
                  symbol: "BTCUSDT",
                  side: "LONG",
                  position_amount: 0.5,
                  entry_price: 65_000,
                  leverage: 8,
                  position_initial_margin: 4_062.5,
                  open_order_initial_margin: 0,
                  unrealized_profit: 2_750,
                },
                {
                  symbol: "ETHUSDT",
                  side: "SHORT",
                  position_amount: -20,
                  entry_price: 3_100,
                  leverage: 5,
                  position_initial_margin: 12_400,
                  open_order_initial_margin: 1_200,
                  unrealized_profit: -800,
                },
              ],
              spot_balances: [
                {
                  asset: "USDT",
                  total_wallet: 80_000,
                  cross_free: 60_000,
                  cross_locked: 20_000,
                  cross_borrowed: 0,
                  cross_interest: 0,
                  um_wallet: 1_000,
                  um_unrealized_pnl: 0,
                },
                {
                  asset: "BTC",
                  total_wallet: 1.25,
                  cross_free: 1.0,
                  cross_locked: 0.25,
                  cross_borrowed: 0,
                  cross_interest: 0,
                  um_wallet: 0,
                  um_unrealized_pnl: 0,
                },
                {
                  asset: "ETH",
                  total_wallet: 50,
                  cross_free: 48,
                  cross_locked: 2,
                  cross_borrowed: 1.2,
                  cross_interest: 0.05,
                  um_wallet: 0,
                  um_unrealized_pnl: 0,
                },
              ],
            },
            serverTs
          );
          setStatus("warn", "示例数据（离线）");
        }

        filterInput.addEventListener("input", () => {
          dirty.exposure = true;
          dirty.positions = true;
          updateMeta();
        });
        reloadBtn.addEventListener("click", () => {
          connect();
        });
        demoBtn.addEventListener("click", () => {
          loadDemoData();
        });

        if (!window.DISABLE_AUTO_CONNECT) {
          connect();
        } else {
          setStatus("warn", "自动连接已禁用");
        }

        setInterval(() => {
          updateMeta();
        }, 1000);

        updateMeta();
      })();
    </script>
  </body>
</html>
